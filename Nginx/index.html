



<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="A Material Design theme for MyNotes">
      
      
      
        <meta name="author" content="Anonymous">
      
      
        <meta name="lang:clipboard.copy" content="复制">
      
        <meta name="lang:clipboard.copied" content="已复制">
      
        <meta name="lang:search.language" content="ja">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="没有找到符合条件的结果">
      
        <meta name="lang:search.result.one" content="找到 1 个符合条件的结果">
      
        <meta name="lang:search.result.other" content="# 个符合条件的结果">
      
        <meta name="lang:search.tokenizer" content="[\uff0c\u3002]+">
      
      <link rel="shortcut icon" href="../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.2">
    
    
      
        <title>Nginx - Material Design for MyNotes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="manifest" href="../manifest.webmanifest">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-131093963-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="light-green">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#nginxunit" tabindex="1" class="md-skip">
        跳转至
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Material Design for MyNotes" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Material Design for MyNotes
            </span>
            <span class="md-header-nav__topic">
              
                Nginx
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            键入以开始搜索
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/Black-Gold/MyNotes/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Black-Gold/MyNotes
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Material Design for MyNotes" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Material Design for MyNotes
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/Black-Gold/MyNotes/" title="前往 Github 仓库" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Black-Gold/MyNotes
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../Vim/" title="Vim" class="md-nav__link">
      Vim
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Languages
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Languages
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Regex/" title="Regex" class="md-nav__link">
      Regex
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Shell/" title="Shell" class="md-nav__link">
      Shell
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Python3/" title="Python3" class="md-nav__link">
      Python3
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Go/" title="Go" class="md-nav__link">
      Go
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      CloudNative
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        CloudNative
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Docker/" title="Docker" class="md-nav__link">
      Docker
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Kubernetes/" title="Kubernetes" class="md-nav__link">
      Kubernetes
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Coreos/" title="ContainerOS" class="md-nav__link">
      ContainerOS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Servers
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Servers
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Linux/" title="Linux" class="md-nav__link">
      Linux
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Utilities/" title="Iproute2&Net-tools" class="md-nav__link">
      Iproute2&Net-tools
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Iptables/" title="Iptables" class="md-nav__link">
      Iptables
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Firewalld/" title="Firewalld" class="md-nav__link">
      Firewalld
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Ansible/" title="Ansible" class="md-nav__link">
      Ansible
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Windows/" title="WindowsServer" class="md-nav__link">
      WindowsServer
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6" checked>
    
    <label class="md-nav__link" for="nav-6">
      WebServer
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        WebServer
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Nginx
      </label>
    
    <a href="./" title="Nginx" class="md-nav__link md-nav__link--active">
      Nginx
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#centos" class="md-nav__link">
    centos安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    关于构建模块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    包括非默认构建的模块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    其他模块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    nginx内核相关参数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    初学者指南
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    静态内容
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    设置简单的代理服务器
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastcgi" class="md-nav__link">
    设置FastCGI代理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginxconf" class="md-nav__link">
    Nginx的conf配置文件详解
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_1" class="md-nav__link">
    nginx日志相关命令
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit180" class="md-nav__link">
    Unit1.8.0
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Apache/" title="Apache" class="md-nav__link">
      Apache
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Tomcat/" title="Tomcat" class="md-nav__link">
      Tomcat
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Caddy/" title="Caddy" class="md-nav__link">
      Caddy
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Database
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Database
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../MySQL/" title="MySQL" class="md-nav__link">
      MySQL
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../MySQL/" title="MariaDB" class="md-nav__link">
      MariaDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Oracle/" title="Oracle" class="md-nav__link">
      Oracle
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../MongoDB/" title="MongoDB" class="md-nav__link">
      MongoDB
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Redis/" title="Redis" class="md-nav__link">
      Redis
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Memcached/" title="Memcached" class="md-nav__link">
      Memcached
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Monitor
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Monitor
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Zabbix/" title="Zabbix" class="md-nav__link">
      Zabbix
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Elk/" title="ELKStack" class="md-nav__link">
      ELKStack
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Prometheus/" title="Prometheus" class="md-nav__link">
      Prometheus
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Grafana/" title="Grafana" class="md-nav__link">
      Grafana
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Nagios/" title="Nagios" class="md-nav__link">
      Nagios
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      CI/CD
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        CI/CD
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Git/" title="Git&GitLab" class="md-nav__link">
      Git&GitLab
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Jenkins/" title="Jenkins" class="md-nav__link">
      Jenkins
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Cache
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Cache
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Squid/" title="Squid" class="md-nav__link">
      Squid
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Varnish/" title="Varnish" class="md-nav__link">
      Varnish
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Stunnel/" title="Stunnel" class="md-nav__link">
      Stunnel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../TrafficServer/" title="ApacheTraffic" class="md-nav__link">
      ApacheTraffic
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-11" type="checkbox" id="nav-11">
    
    <label class="md-nav__link" for="nav-11">
      LB&HA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-11">
        LB&HA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../LVS/" title="LVS" class="md-nav__link">
      LVS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Haproxy/" title="HAProxy" class="md-nav__link">
      HAProxy
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-12" type="checkbox" id="nav-12">
    
    <label class="md-nav__link" for="nav-12">
      MessageQueue
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-12">
        MessageQueue
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Kafka/" title="Kafka" class="md-nav__link">
      Kafka
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ActiveMQ/" title="ActiveMQ" class="md-nav__link">
      ActiveMQ
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RabbitMQ/" title="RabbitMQ" class="md-nav__link">
      RabbitMQ
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-13" type="checkbox" id="nav-13">
    
    <label class="md-nav__link" for="nav-13">
      FileSystem
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-13">
        FileSystem
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Ceph/" title="Ceph" class="md-nav__link">
      Ceph
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../GlusterFS/" title="GlusterFS" class="md-nav__link">
      GlusterFS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-14" type="checkbox" id="nav-14">
    
    <label class="md-nav__link" for="nav-14">
      Network
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-14">
        Network
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../Cisco/" title="Cisco" class="md-nav__link">
      Cisco
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Monitors/" title="Monitors" class="md-nav__link">
      Monitors
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Others/" title="Others" class="md-nav__link">
      Others
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">目录</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#centos" class="md-nav__link">
    centos安装
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    关于构建模块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    包括非默认构建的模块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    其他模块
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx" class="md-nav__link">
    nginx内核相关参数
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    初学者指南
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    静态内容
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    设置简单的代理服务器
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fastcgi" class="md-nav__link">
    设置FastCGI代理
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginxconf" class="md-nav__link">
    Nginx的conf配置文件详解
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nginx_1" class="md-nav__link">
    nginx日志相关命令
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unit180" class="md-nav__link">
    Unit1.8.0
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/Black-Gold/MyNotes/edit/master/docs/Nginx.md" title="编辑此页" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="nginxunit">Nginx&amp;&amp;Unit<a class="headerlink" href="#nginxunit" title="Permanent link">&para;</a></h1>
<h2 id="centos">centos安装<a class="headerlink" href="#centos" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="c1"># To set up the yum repository for RHEL/CentOS, create the file named /etc/yum.repos.d/nginx.repo with the following contents:</span>
<span class="c1"># Replace “OS” with “rhel” or “centos”, depending on the distribution used, and “OSRELEASE” with “6” or “7”, for 6.x or 7.x versions, respectively.</span>
cat <span class="s">&lt;&lt; EOF &gt; /etc/yum.repos.d/nginx.repo</span>
<span class="s">[nginx-stable]</span>
<span class="s">name=nginx stable repo</span>
<span class="s">baseurl=http://nginx.org/packages/OS/OSRELEASE/$basearch/</span>
<span class="s">gpgcheck=1</span>
<span class="s">enabled=1</span>
<span class="s">gpgkey=https://nginx.org/keys/nginx_signing.key</span>
<span class="s">EOF</span>


<span class="c1"># 对于Debian / Ubuntu，为了验证nginx存储库签名并在安装nginx软件包时消除有关丢失PGP密钥的警告，有必要将用于签署nginx软件包和存储库的密钥添加到apt程序密钥环中。请从我们的网站下载此密钥，并apt 使用以下命令将其添加到程序密钥环：</span>
wget -c http://nginx.org/keys/nginx_signing.key
sudo apt-key add nginx_signing.key

<span class="c1"># 对于Debian，用Debian分发代号取代codename</span>
cat <span class="s">&lt;&lt; EOF &gt; /etc/apt/sources.list</span>
<span class="s">deb http://nginx.org/packages/debian/ codename nginx</span>
<span class="s">deb-src http://nginx.org/packages/debian/ codename nginx</span>
<span class="s">EOF</span>

apt-get update <span class="o">&amp;&amp;</span> apt-get install nginx

<span class="c1"># Mainline版本的预构建包;利用rpm包安装</span>
rpm --import nginx_signing.key
wget http://nginx.org/packages/mainline/centos/7/x86_64/RPMS/nginx-1.13.9-1.el7_4.ngx.x86_64.rpm
rpm -ivh nginx-1.13.9-1.el7_4.ngx.x86_64.rpm
systemctl <span class="nb">enable</span> nginx <span class="o">&amp;&amp;</span> systemctl start nginx
</pre></div>

<p>2.从源代码构建nginx</p>
<div class="codehilite"><pre><span></span>wget -c http://nginx.org/download/nginx-1.12.2.tar.gz
<span class="c1"># 构建使用configure命令进行配置。它定义了系统的各个方面，包括nginx允许用于连接处理的方法。最后它创建一个Makefile。该configure命令支持以下参数：</span>

--prefix<span class="o">=</span>path - 定义一个将保留服务器文件的目录。这个相同的目录也将被用于所有相关的路径 configure（除了源资源的路径）和nginx.conf配置文件。它/usr/local/nginx默认设置为目录

--sbin-path<span class="o">=</span>path - 设置一个nginx可执行文件的名字。该名称仅在安装过程中使用。默认情况下，该文件被命名 prefix/sbin/nginx

--conf-path<span class="o">=</span>path - 设置nginx.conf配置文件的名称。如果需要的话，nginx可以始终使用不同的配置文件启动，只要在命令行参数中指定即可 。默认情况下，该文件被命名 。 -c fileprefix/conf/nginx.conf

--pid-path<span class="o">=</span>path - 设置将存储主进程的进程ID的nginx.pid文件的名称。安装完成后，可以nginx.conf使用pid指令始终在配置文件中 更改文件名 。默认情况下，该文件被命名 prefix/logs/nginx.pid

--error-log-path<span class="o">=</span>path - 设置主要错误的名称，警告和诊断文件。安装之后，可以nginx.conf使用error_log指令始终在配置文件中 更改文件名 。默认情况下，该文件被命名 prefix/logs/error.log

--http-log-path<span class="o">=</span>path - 设置HTTP服务器的主要请求日志文件的名称。安装完成后，可以nginx.conf使用access_log指令随时在配置文件中 更改文件名 。默认情况下，该文件被命名 prefix/logs/access.log

--build<span class="o">=</span>name - 设置一个可选的nginx构建名称

--user<span class="o">=</span>name - 设置工作进程将使用其凭据的非特权用户的名称。安装完成后，可以nginx.conf使用user指令始终在配置文件中 更改名称 。默认的用户名是nobody

--group<span class="o">=</span>name - 设置工作进程将使用其凭据的组的名称。安装完成后，可以nginx.conf使用user指令始终在配置文件中 更改名称 。默认情况下，组名称设置为非特权用户的名称

--with-select_module
--without-select_module - 启用或禁用构建允许服务器使用该select<span class="o">()</span>方法的模块 。如果平台不支持更合适的方法（如kqueue，epoll或/ dev / poll），则自动构建此模块

--with-poll_module
--without-poll_module - 启用或禁用构建允许服务器使用该poll<span class="o">()</span>方法的模块 。如果平台不支持更合适的方法（如kqueue，epoll或/ dev / poll），则自动构建此模块

--without-http_gzip_module - 禁用构建压缩 HTTP服务器响应的模块。zlib库是建立和运行这个模块所必需的

--without-http_rewrite_module - 禁用构建允许HTTP服务器 重定向请求并更改请求URI的模块。PCRE库需要构建和运行这个模块

--without-http_proxy_module - 禁用构建HTTP服务器代理模块

--with-http_ssl_module - 可以构建一个模块，将HTTPS协议支持添加到HTTP服务器。该模块不是默认生成的。OpenSSL库需要构建和运行这个模块

--with-pcre<span class="o">=</span>path - 设置PCRE库源的路径。图书馆发行（版本4.4 - <span class="m">8</span>.41）需要从PCRE网站下载 并提取。其余的是由nginx的./configure和 make。在位置指令和 ngx_http_rewrite_module 模块中，该库是正则表达式支持所必需的

--with-pcre-jit - 用“即时编译”支持（1.1.12，pcre_jit指令）构建PCRE库

--with-zlib<span class="o">=</span>path - 设置zlib库的源的路径。库发行版（版本1.1.3 - <span class="m">1</span>.2.11）需要从zlib站点下载 并提取。其余的是由nginx的./configure和 make。该库是ngx_http_gzip_module模块所必需的

--with-cc-opt<span class="o">=</span>parameters - 设置将被添加到CFLAGS变量的附加参数。在FreeBSD下使用系统PCRE库时， --with-cc-opt<span class="o">=</span><span class="s2">&quot;-I /usr/local/include&quot;</span> 应该指定。如果select<span class="o">()</span>需要增加支持的文件数量，也可以在这里指定如下： --with-cc-opt<span class="o">=</span><span class="s2">&quot;-D FD_SETSIZE=2048&quot;</span>

--with-ld-opt<span class="o">=</span>parameters - 设置将在链接期间使用的其他参数。在FreeBSD下使用系统PCRE库时， --with-ld-opt<span class="o">=</span><span class="s2">&quot;-L /usr/local/lib&quot;</span> 应该指定

参数使用示例（所有这些都需要输入一行）：

./configure --sbin-path<span class="o">=</span>/usr/local/nginx/nginx --conf-path<span class="o">=</span>/usr/local/nginx/nginx.conf --pid-path<span class="o">=</span>/usr/local/nginx/nginx.pid --with-http_ssl_module --with-pcre<span class="o">=</span>../pcre-8.41 --with-zlib<span class="o">=</span>../zlib-1.2.11
配置完成后，make <span class="o">&amp;&amp;</span> make install安装

验证nginx是否运行：curl -I <span class="m">127</span>.0.0.1
</pre></div>

<h2 id="_1">关于构建模块<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>默认情况下不包括的模块以及第三方模块必须在configure脚本中与其他构建选项一起显式指定。这些模块可以静态链接到NGINX二进制文件（每次NGINX启动时加载它们）或动态加载（只有在NGINX配置文件中包含相关指令时才加载它们

默认构建的模块
如果您不需要默认构建的模块，可以通过使用脚本--without-&lt;MODULE-NAME&gt;上的选项命名它来禁用它configure，如此示例中禁用Empty GIF模块（应该键入为单行）：
</pre></div>

<p>默认构建的模块如下：
| 模块名称 | 描述 |
| :------: | :------: |
| http_access_module | 接受或拒绝来自指定客户端地址的请求。 |
| http_auth_basic_module | 通过使用HTTP基本身份验证协议验证用户名和密码来限制对资源的访问。 |
| http_autoindex_module | 处理以正斜杠字符（/）结尾的请求，并生成目录列表。 |
| http_browser_module | 创建其值取决于User-Agent请求标头值的变量。 |
| http_charset_module | 将指定的字符集添加到Content-Type响应标头。可以将数据从一个字符集转换为另一个字符集 |
| http_empty_gif_module | 发出单像素透明GIF。 |
| http_fastcgi_module | 将请求传递给FastCGI服务器。 |
| http_geo_module | 使用取决于客户端IP地址的值创建变量。 |
| http_gzip_module | 使用gzip压缩响应，将传输数据量减少一半或更多。 |
| http_limit_conn_module | 限制每个定义密钥的连接数，特别是来自单个IP地址的连接数。 |
| http_limit_req_module | 限制每个定义密钥的请求处理速率，特别是来自单个IP地址的请求的处理速率。 |
| http_map_module | 创建其值取决于其他变量值的变量。 |
| http_memcached_module | 将请求传递给memcached服务器。 |
| http_proxy_module | 将HTTP请求传递给另一台服务器。 |
| http_referer_module | 在Referer标头中阻止具有无效值的请求。 |
| http_rewrite_module | 使用正则表达式更改请求URI并返回重定向; 有条件地选择配置。需要PCRE库。 |
| http_scgi_module | 将请求传递给SCGI服务器。 |
| http_ssi_module | 在通过它的响应中处理SSI（服务器端包含）命令。 |
| http_split_clients_module | 创建适合A / B测试的变量，也称为拆分测试。 |
| http_upstream_hash_module | 启用通用哈希负载平衡方法。 |
| http_upstream_ip_hash_module | 启用IP哈希负载平衡方法。 |
| http_upstream_keepalive_module | 启用keepalive连接。 |
| http_upstream_least_conn_module | 启用最少连接负载平衡方法。 |
| http_upstream_zone_module | 启用共享内存区域。 |
| http_userid_module | 设置适合客户识别的cookie。 |
| http_uwsgi_module | 将请求传递给uwsgi服务器。 |</p>
<h2 id="_2">包括非默认构建的模块<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>默认情况下不构建许多NGINX模块，必须在configure要构建的命令行中列出
| 模块名称 | 描述 |
| :------: | :------: |
| --with-cpp_test_module | 测试头文件的C ++兼容性。 |
| --with-debug | 启用调试日志。 |
| --with-file-aio | 启用异步I / O. |
| --with-google_perftools_module | 允许使用<a href="https://github.com/gperftools/gperftools">Google Performance</a>工具库 |
| -- 与-http_addition_module | 在响应之前和之后添加文本。 |
| -- 与-http_auth_request_module | 根据子请求的结果实现客户端授权。 |
| -- 与-http_dav_module | 使用WebDAV协议启用文件管理自动化。 |
| --with-http_degradation_module | 允许在内存大小超过定义的值时返回错误。 |
| -- 与-http_flv_module | 为Flash Video（FLV）文件提供伪流服务器端支持。 |
| -- 与-http_geoip_module | 允许创建其值取决于客户端IP地址的变量。该模块使用MaxMind GeoIP数据库。要编译为单独的动态模块，请将选项更改为-with-http_geoip_module = dynamic。 |
| -- 与-http_gunzip_module | 使用Content-Encoding解压缩响应：gzip用于不支持_zip_ encoding方法的客户端。 |
| -- 与-http_gzip_static_module | 允许使用.gz文件扩展名而不是常规文件发送预压缩文件。 |
| -- 与-http_image_filter_module | 以JPEG，GIF和PNG格式转换图像。该模块需要LibGD库。要编译为单独的动态模块，请将选项更改为--with-http_image_filter_module=dynamic。 |
| -- 与-http_mp4_module | 为MP4文件提供伪流服务器端支持。 |
| -- 与-http_perl_module | 用于在Perl中实现位置和变量处理程序，并将Perl调用插入SSI。需要PERL库。要编译为单独的动态模块，请将选项更改为--with-http_perl_module=dynamic。 |
| -- 与-http_random_index_module | 处理以斜杠字符（'/'）结尾的请求，并在目录中选择一个随机文件作为索引文件。 |
| -- 与-http_realip_module | 将客户端地址更改为在指定的标头字段中发送的地址。 |
| -- 与-http_secure_link_module | 用于检查请求的链接的真实性，保护资源免受未经授权的访问，并限制链接的生命周期。 |
| -- 与-http_slice_module | 允许将请求拆分为子请求，每个子请求返回一定范围的响应。提供更有效的大文件缓存。 |
| -- 与-http_ssl_module | 启用HTTPS支持。需要一个SSL库，如OpenSSL。 |
| -- 与-http_stub_status_module | 提供对基本状态信息的访问。请注意，NGINX Plus客户不需要此模块，因为它们已经提供了扩展状态指标和交互式仪表板。 |
| -- 与-http_sub_module | 通过将一个指定的字符串替换为另一个来修改响应。 |
| -- 与-http_xslt_module | 使用一个或多个XSLT样式表转换XML响应。该模块需要Libxml2和XSLT库。要编译为单独的动态模块，请将选项更改为--with-http_xslt_module=dynamic。 |
| -- 与-http_v2_module | 启用对HTTP / 2的支持。有关详细信息，请参阅NGINX博客上NGINX中的HTTP / 2模块。 |
| -- 用邮件 | 启用邮件代理功能。要编译为单独的动态模块，请将选项更改为--with-mail=dynamic。 |
| -- 与-mail_ssl_module | 为邮件代理服务器提供支持以使用SSL / TLS协议。需要一个SSL库，如OpenSSL。 |
| -- 与流 | 启用TCP和UDP代理功能。要编译为单独的动态模块，请将选项更改为--with-stream=dynamic。 |
| -- 与-stream_ssl_module | 为流代理服务器提供支持以使用SSL / TLS协议。需要一个SSL库，如OpenSSL。 |
| --with-threads | 使NGINX能够使用线程池。有关详细信息，请参阅NGINX Boost Performance 9x中的线程池！在NGINX博客上。 |</p>
<h2 id="_3">其他模块<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="err">静态链接模块</span>
<span class="n">NGINX开源中内置的大多数模块都是静态链接的</span><span class="err">：它们在编译时内置于</span><span class="n">NGINX开源中</span><span class="err">，并静态链接到</span><span class="n">NGINX二进制文件</span><span class="err">。</span> <span class="err">只能通过重新编译</span><span class="n">NGINX来禁用这些模块</span><span class="err">。</span><span class="p">[</span><span class="n">NGINX</span> <span class="n">Wiki</span><span class="p">](</span><span class="nl">https</span><span class="p">:</span><span class="c1">//nginx.com/resources/wiki/modules/)中   列出了一些第三方模块</span>
<span class="err">要使用静态链接的第三方模块编译</span><span class="n">NGINX</span> <span class="n">Open</span> <span class="n">Source</span><span class="err">，请</span><span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span><span class="o">=&lt;</span><span class="n">PATH</span><span class="o">&gt;</span><span class="err">在</span><span class="n">configure命令中包含选项</span><span class="err">，</span>   <span class="err">其中</span><span class="o">&lt;</span><span class="n">PATH</span><span class="o">&gt;</span><span class="err">是源代码的路径（此示例适用于</span><span class="n">RTMP</span> <span class="err">模块）：</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="p">...</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">module</span> <span class="o">=</span> <span class="o">/</span> <span class="n">usr</span> <span class="o">/</span> <span class="n">build</span> <span class="o">/</span> <span class="n">nginx</span><span class="o">-</span><span class="n">rtmp</span><span class="o">-</span><span class="n">module</span>

<span class="err">动态链接模块</span>
<span class="n">NGINX模块也可以编译为共享对象</span><span class="err">（</span><span class="o">*</span> <span class="p">.</span><span class="n">so文件</span><span class="err">），然后在运行时动态加载到</span><span class="n">NGINX</span> <span class="n">Open</span> <span class="n">Source中</span><span class="err">。这提供了更大的</span>   <span class="err">灵活性，因为可以通过</span><span class="n">load_module在NGINX配置文件中添加或删除关联指令并重新加载配置来随时加载或卸载模块</span><span class="err">。</span> <span class="err">请注意，模块本身必须支持动态链接</span>
<span class="err">要使用动态加载的第三方模块编译</span><span class="n">NGINX</span> <span class="n">Open</span> <span class="n">Source</span><span class="err">，请</span><span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">dynamic</span><span class="o">-</span><span class="n">module</span><span class="o">=&lt;</span><span class="n">PATH</span><span class="o">&gt;</span><span class="err">在</span><span class="n">configure命令中</span> <span class="err">包含选项，其中</span><span class="o">&lt;</span><span class="n">PATH</span><span class="o">&gt;</span><span class="err">是源代码的路径：</span>
<span class="p">.</span><span class="o">/</span><span class="n">configure</span> <span class="p">...</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">dynamic</span><span class="o">-</span><span class="n">module</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">PATH</span><span class="o">&gt;</span>
<span class="err">生成的</span><span class="o">*</span> <span class="p">.</span><span class="n">so文件将写入前缀</span><span class="o">/</span> <span class="n">modules</span> <span class="o">/</span><span class="err">目录，其中前缀是服务器文件的目录，例如</span><span class="o">/</span> <span class="n">usr</span> <span class="o">/</span> <span class="n">local</span> <span class="o">/</span> <span class="n">nginx</span> <span class="o">/</span>
<span class="err">要加载动态模块，请</span><span class="n">load_module在安装后将指令添加到NGINX配置</span><span class="err">：</span>
<span class="n">load_module</span> <span class="n">modules</span> <span class="o">/</span> <span class="n">ngx_mail_module</span><span class="p">.</span><span class="n">so</span><span class="p">;</span>
</pre></div>


<h2 id="nginx">nginx内核相关参数<a class="headerlink" href="#nginx" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span># <span class="o">/</span><span class="nv">etc</span><span class="o">/</span><span class="nv">sysctl</span>.<span class="nv">conf</span>
# <span class="nv">Avoid</span> <span class="nv">a</span> <span class="nv">smurf</span> <span class="nv">attack</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">icmp_echo_ignore_broadcasts</span> <span class="o">=</span> <span class="mi">1</span>

# <span class="nv">Turn</span> <span class="nv">on</span> <span class="nv">protection</span> <span class="k">for</span> <span class="nv">bad</span> <span class="nv">icmp</span> <span class="nv">error</span> <span class="nv">messages</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">icmp_ignore_bogus_error_responses</span> <span class="o">=</span> <span class="mi">1</span>

# <span class="nv">Turn</span> <span class="nv">on</span> <span class="nv">syncookies</span> <span class="k">for</span> <span class="nv">SYN</span> <span class="nv">flood</span> <span class="nv">attack</span> <span class="nv">protection</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_syncookies</span> <span class="o">=</span> <span class="mi">1</span>

# <span class="nv">Turn</span> <span class="nv">on</span> <span class="nv">and</span> <span class="nv">log</span> <span class="nv">spoofed</span>, <span class="nv">source</span> <span class="nv">routed</span>, <span class="nv">and</span> <span class="nv">redirect</span> <span class="nv">packets</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">all</span>.<span class="nv">log_martians</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">log_martians</span> <span class="o">=</span> <span class="mi">1</span>

# <span class="nv">No</span> <span class="nv">source</span> <span class="nv">routed</span> <span class="nv">packets</span> <span class="nv">here</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">all</span>.<span class="nv">accept_source_route</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">accept_source_route</span> <span class="o">=</span> <span class="mi">0</span>

# <span class="nv">Turn</span> <span class="nv">on</span> <span class="nv">reverse</span> <span class="nv">path</span> <span class="nv">filtering</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">all</span>.<span class="nv">rp_filter</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">rp_filter</span> <span class="o">=</span> <span class="mi">1</span>

# <span class="nv">Make</span> <span class="nv">sure</span> <span class="nv">no</span> <span class="nv">one</span> <span class="nv">can</span> <span class="nv">alter</span> <span class="nv">the</span> <span class="nv">routing</span> <span class="nv">tables</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">all</span>.<span class="nv">accept_redirects</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">accept_redirects</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">all</span>.<span class="nv">secure_redirects</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">secure_redirects</span> <span class="o">=</span> <span class="mi">0</span>

# <span class="nv">Don</span><span class="s1">&#39;</span><span class="s">t act as a router</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">ip_forward</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">all</span>.<span class="nv">send_redirects</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">send_redirects</span> <span class="o">=</span> <span class="mi">0</span>


# <span class="nv">Turn</span> <span class="nv">on</span> <span class="nv">execshild</span>
<span class="nv">kernel</span>.<span class="k">exec</span><span class="o">-</span><span class="nv">shield</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nv">kernel</span>.<span class="nv">randomize_va_space</span> <span class="o">=</span> <span class="mi">1</span>

# <span class="nv">Tuen</span> <span class="nv">IPv6</span>
<span class="nv">net</span>.<span class="nv">ipv6</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">router_solicitations</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv6</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">accept_ra_rtr_pref</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv6</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">accept_ra_pinfo</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv6</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">accept_ra_defrtr</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv6</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">autoconf</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv6</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">dad_transmits</span> <span class="o">=</span> <span class="mi">0</span>
<span class="nv">net</span>.<span class="nv">ipv6</span>.<span class="nv">conf</span>.<span class="nv">default</span>.<span class="nv">max_addresses</span> <span class="o">=</span> <span class="mi">1</span>

# <span class="nv">Optimization</span> <span class="k">for</span> <span class="nv">port</span> <span class="nv">usefor</span> <span class="nv">LBs</span>
# <span class="nv">Increase</span> <span class="nv">system</span> <span class="nv">file</span> <span class="nv">descriptor</span> <span class="nv">limit</span>
<span class="nv">fs</span>.<span class="nv">file</span><span class="o">-</span><span class="nv">max</span> <span class="o">=</span> <span class="mi">65535</span>

# <span class="nv">Allow</span> <span class="k">for</span> <span class="nv">more</span> <span class="nv">PIDs</span> <span class="ss">(</span><span class="nv">to</span> <span class="nv">reduce</span> <span class="nv">rollover</span> <span class="nv">problems</span><span class="ss">)</span><span class="c1">; may break some programs 32768</span>
<span class="nv">kernel</span>.<span class="nv">pid_max</span> <span class="o">=</span> <span class="mi">65536</span>

# <span class="nv">Increase</span> <span class="nv">system</span> <span class="nv">IP</span> <span class="nv">port</span> <span class="nv">limits</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">ip_local_port_range</span> <span class="o">=</span> <span class="mi">2000</span> <span class="mi">65000</span>

# <span class="nv">Increase</span> <span class="nv">TCP</span> <span class="nv">max</span> <span class="nv">buffer</span> <span class="nv">size</span> <span class="nv">setable</span> <span class="nv">using</span> <span class="nv">setsockopt</span><span class="ss">()</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_rmem</span> <span class="o">=</span> <span class="mi">4096</span> <span class="mi">87380</span> <span class="mi">8388608</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_wmem</span> <span class="o">=</span> <span class="mi">4096</span> <span class="mi">87380</span> <span class="mi">8388608</span>

# <span class="nv">Increase</span> <span class="nv">Linux</span> <span class="nv">auto</span> <span class="nv">tuning</span> <span class="nv">TCP</span> <span class="nv">buffer</span> <span class="nv">limits</span>
# <span class="nv">min</span>, <span class="nv">default</span>, <span class="nv">and</span> <span class="nv">max</span> <span class="nv">number</span> <span class="nv">of</span> <span class="nv">bytes</span> <span class="nv">to</span> <span class="nv">use</span>
# <span class="nv">set</span> <span class="nv">max</span> <span class="nv">to</span> <span class="nv">at</span> <span class="nv">least</span> <span class="mi">4</span><span class="nv">MB</span>, <span class="nv">or</span> <span class="nv">higher</span> <span class="k">if</span> <span class="nv">you</span> <span class="nv">use</span> <span class="nv">very</span> <span class="nv">high</span> <span class="nv">BDP</span> <span class="nv">paths</span>
# <span class="nv">Tcp</span> <span class="nv">Windows</span> <span class="nv">etc</span>
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">rmem_max</span> <span class="o">=</span> <span class="mi">8388608</span>
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">wmem_max</span> <span class="o">=</span> <span class="mi">8388608</span>
<span class="nv">net</span>.<span class="nv">core</span>.<span class="nv">netdev_max_backlog</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="nv">net</span>.<span class="nv">ipv4</span>.<span class="nv">tcp_window_scaling</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>

<h2 id="_4">初学者指南<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>要启动nginx，请运行可执行文件。启动nginx后，可以通过使用-s参数调用可执行文件来控制它。使用以下语法：
nginx -s signal
signal可以是下列之一：
stop - 快速关机
quit - 优雅的关机
reload - 重新加载配置文件
reopen - 重新打开日志文件

例如，要在等待工作进程完成当前请求的服务时停止nginx进程，可以执行以下命令：
nginx -s quit
此命令应在启动nginx的同一用户下执行

nginx由模块组成，模块由配置文件指定的指令控制，指令分为简单指令和块指令，简单指令包括由空格分隔的名称和参数，以分号结尾，块指令和简单指令相同结构，但不以分号结尾，而是以大括号<span class="o">{}</span>包围的一组附加指令结束，若块指令可以在大括号包含其他指令，则称为上下文。如：events,http,server和location
放置在任何上下文之外的配置文件中的指令都被认为是在主上下文中。在events和http指令驻留在main上下文server中，http和location在server中
</pre></div>

<h2 id="_5">静态内容<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>从/data/www目录提供文件，编辑配置文件并使用两个location块在http块内设置server块
将html等静态文件放入/data/www，打开配置文件，默认已包含几个server块实例
http <span class="o">{</span>
  server <span class="o">{</span>
  <span class="o">}</span>
<span class="o">}</span>
通常配置文件包括它监听的端口和服务器名称区分的若干个server块，一旦nginx决定对请求进行处理，它根据块的定义的指令参数测试请求头中指定的URI
将以下location块添加到server块中
location / <span class="o">{</span>
  root /data/ww<span class="p">;</span>
<span class="o">}</span>
此location块指定/与请求中的URI进行比较的“/”前缀。对于匹配请求，URI将添加到root 指令中指定的路径 ，即to /data/www，以形成本地文件系统上所请求文件的路径。如果存在多个匹配location块，则nginx选择具有最长前缀的块。location上面的块提供长度为1的最短前缀，因此只有当所有其他location 块都无法提供匹配时，才会使用此块
接着添加第二个location块：
location /images/ <span class="o">{</span>
  root /data<span class="p">;</span>
<span class="o">}</span>
它将匹配以/images/开头的请求<span class="o">(</span>location / 也匹配此类请求，但前缀更短<span class="o">)</span>

server块 的结果配置应如下所示：

server <span class="o">{</span>
    location / <span class="o">{</span>
        root /data/www<span class="p">;</span>
    <span class="o">}</span>

    location /images/ <span class="o">{</span>
        root /data<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<h2 id="_6">设置简单的代理服务器<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>nginx可以用作代理服务器，即服务器接受请求，将这些请求传递给代理服务器，从中检索响应，然后返回给客户端
我们将配置一个基本代理服务器，它使用来自本地目录的文件处理图像请求，并将所有其他请求发送到代理服务器。在此示例中，将在单个nginx实例上定义两个服务器

向server nginx的配置文件添加一个以上内容来定义代理服务器，其中包含以下内容：

server <span class="o">{</span>
    listen <span class="m">8080</span><span class="p">;</span>
    root /data/up1<span class="p">;</span>

    location / <span class="o">{</span>
    <span class="o">}</span>
<span class="o">}</span>
这将是一个侦听端口8080的简单服务器（之前，listen自使用标准端口80以来未指定该指令）并将所有请求映射到/data/up1本地文件系统上的目录。创建此目录并将index.html文件放入其中。请注意，该root指令放在 server上下文中，当location选择用于提供请求的块不包括自己的root指令时，使用这样的指令
接下来，使用上一节中的服务器配置并对其进行修改以使其成为代理服务器配置。在第一个location块中，将 proxy_pass 指令与参数中指定的代理服务器的协议，名称和端口放在一起（在我们的示例中，它是http://localhost:8080）：

server <span class="o">{</span>
    location / <span class="o">{</span>
        proxy_pass http：//localhost：8080<span class="p">;</span>
    <span class="o">}</span>

    location / images / <span class="o">{</span>
        root / data<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
我们将修改第二个location 块，该块当前将带有/images/前缀的请求映射到目录下的/data/images文件，以使其与具有典型文件扩展名的图像请求相匹配。修改后的location块看起来像这样：
location ~ <span class="se">\.</span><span class="o">(</span>gif<span class="p">|</span>jpg<span class="p">|</span>png<span class="o">)</span>$ <span class="o">{</span>
    root /data/images<span class="p">;</span>
<span class="o">}</span>
该参数是一个正则表达式匹配结尾的所有URI .gif，.jpg或.png。应该以正则表达式开头~。相应的请求将映射到该/data/images 目录

当nginx选择一个location块来提供请求时，它首先检查 指定前缀的位置指令，记住location 最长的前缀，然后检查正则表达式。如果与正则表达式匹配，则nginx选择此项 location，否则，它会选择之前记住的那个
生成的代理服务器配置如下所示：
server <span class="o">{</span>
    location / <span class="o">{</span>
        proxy_pass http://localhost:8080/<span class="p">;</span>
    <span class="o">}</span>

    location ~ <span class="se">\.</span><span class="o">(</span>gif<span class="p">|</span>jpg<span class="p">|</span>png<span class="o">)</span>$ <span class="o">{</span>
        root /data/images<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
此服务器将过滤以.gif.jpg或者.png 将其映射到/data/images目录的请求（通过向root指令的参数添加URI ）并将所有其他请求传递给上面配置的代理服务器
</pre></div>

<h2 id="fastcgi">设置FastCGI代理<a class="headerlink" href="#fastcgi" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>nginx可用于将请求路由到FastCGI服务器，这些服务器运行使用各种框架和编程语言（如PHP）构建的应用程序

使用FastCGI服务器的最基本的nginx配置包括使用 fastcgi_pass 指令而不是proxy_pass指令，以及fastcgi_param 指令来设置传递给FastCGI服务器的参数。假设可以访问FastCGI服务器localhost:9000。以上一节中的代理配置为基础，将proxy_pass指令替换为指令 fastcgi_pass并将参数更改为 localhost:9000。在PHP中，该SCRIPT_FILENAME参数用于确定脚本名称，该QUERY_STRING 参数用于传递请求参数。结果配置为：
server <span class="o">{</span>
    location / <span class="o">{</span>
        fastcgi_pass  localhost:9000<span class="p">;</span>
        fastcgi_param SCRIPT_FILENAME <span class="nv">$document_root$fastcgi_script_name</span><span class="p">;</span>
        fastcgi_param QUERY_STRING    <span class="nv">$query_string</span><span class="p">;</span>
    <span class="o">}</span>

    location ~ <span class="se">\.</span><span class="o">(</span>gif<span class="p">|</span>jpg<span class="p">|</span>png<span class="o">)</span>$ <span class="o">{</span>
        root /data/images<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
这将设置一个服务器，该服务器将除静态图像请求之外的所有请求路由到localhost:9000通过FastCGI协议操作的代理服务器
</pre></div>

<h2 id="nginxconf">Nginx的conf配置文件详解<a class="headerlink" href="#nginxconf" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="k">nginx及其模块的工作方式在配置文件中确定。默认情况下，配置文件被命名nginx.conf</span> <span class="s">并放在目录</span> <span class="s">/usr/local/nginx/conf中</span> <span class="s">/etc/nginx，或</span> <span class="s">/usr/local/etc/nginx</span>

<span class="s">特定于功能的配置文件</span>
<span class="s">为了使配置更易于维护，我们建议您将其拆分为一组存储在/etc/nginx/conf.d目录中的特定于功能的文件，并使用include主nginx.conf文件中的指令来引用其中的内容</span>
<span class="s">include</span> <span class="s">conf.d/http</span><span class="p">;</span>
<span class="k">include</span> <span class="n">conf.d/stream</span>;
<span class="k">include</span> <span class="n">conf.d/exchange-enhanced</span>;

<span class="k">一些顶级指令（称为Contexts）将适用于不同流量类型的指令组合在一起</span>
<span class="s">events</span> <span class="s">-</span> <span class="s">一般连接处理</span>
<span class="s">http</span> <span class="s">-</span> <span class="s">HTTP流量</span>
<span class="s">mail</span> <span class="s">-</span> <span class="s">邮件流量</span>
<span class="s">stream</span> <span class="s">-</span> <span class="s">TCP和UDP流量</span>

<span class="s">在每个流量处理上下文中，您包含一个或多个server块来定义控制请求处理的虚拟服务器。您可以在server上下文中包含的指令因流量类型而异</span>

<span class="s">对于HTTP流量（http上下文），每个server指令控制对特定域或IP地址的资源请求的处理。location上下文中的一个或多个server上下文定义了如何处理特定的URI集</span>
<span class="s">对于邮件和TCP</span> <span class="s">/</span> <span class="s">UDP流量（mail和stream上下文），server指令各自控制到达特定TCP端口或UNIX套接字的流量的处理</span>
<span class="s">例如：</span>

<span class="s">user</span> <span class="s">nobody</span><span class="p">;</span> <span class="c1"># a directive in the &#39;main&#39; context</span>

<span class="k">events</span> <span class="p">{</span>
    <span class="c1"># configuration of connection processing</span>
<span class="p">}</span>

<span class="k">http</span> <span class="p">{</span>
    <span class="c1"># Configuration specific to HTTP and affecting all virtual servers</span>

    <span class="kn">server</span> <span class="p">{</span>
        <span class="c1"># configuration of HTTP virtual server 1</span>
        <span class="kn">location</span> <span class="s">/one</span> <span class="p">{</span>
            <span class="c1"># configuration for processing URIs starting with &#39;/one&#39;</span>
        <span class="p">}</span>
        <span class="kn">location</span> <span class="s">/two</span> <span class="p">{</span>
            <span class="c1"># configuration for processing URIs starting with &#39;/two&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kn">server</span> <span class="p">{</span>
        <span class="c1"># configuration of HTTP virtual server 2</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">stream</span> <span class="p">{</span>
    <span class="c1"># Configuration specific to TCP/UDP and affecting all virtual servers</span>
    <span class="kn">server</span> <span class="p">{</span>
        <span class="c1"># configuration of TCP virtual server 1</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<div class="codehilite"><pre><span></span>#定义<span class="nv">Nginx</span>运行的用户和用户组
<span class="nv">user</span> <span class="nv">www</span> <span class="nv">www</span><span class="c1">;</span>

#<span class="nv">nginx</span>进程数，建议设置为等于<span class="nv">CPU</span>总核心数
<span class="nv">worker_processes</span> <span class="nv">auto</span><span class="c1">;</span>

#全局错误日志定义类型，[ <span class="nv">debug</span> <span class="o">|</span> <span class="nv">info</span> <span class="o">|</span> <span class="nv">notice</span> <span class="o">|</span> <span class="nv">warn</span> <span class="o">|</span> <span class="nv">error</span> <span class="o">|</span> <span class="nv">crit</span> ]
<span class="nv">error_log</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">error</span>.<span class="nv">log</span> <span class="nv">crit</span><span class="c1">;</span>

#进程文件
<span class="nv">pid</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">run</span><span class="o">/</span><span class="nv">nginx</span>.<span class="nv">pid</span><span class="c1">;</span>

#一个<span class="nv">nginx</span>进程打开的最多文件描述符数目，理论值应该是最多打开文件数（系统的值<span class="nv">ulimit</span> <span class="o">-</span><span class="nv">n</span>）与<span class="nv">nginx</span>进程数相除，但是<span class="nv">nginx</span>分配请求并不均匀，所以建议与<span class="nv">ulimit</span> <span class="o">-</span><span class="nv">n</span>的值保持一致
<span class="nv">worker_rlimit_nofile</span> <span class="mi">65535</span><span class="c1">;</span>

#工作模式与连接数上限
<span class="nv">events</span>
{
#参考事件模型，<span class="nv">use</span> [ <span class="nv">kqueue</span> <span class="o">|</span> <span class="nv">rtsig</span> <span class="o">|</span> <span class="nv">epoll</span> <span class="o">|</span> <span class="o">/</span><span class="nv">dev</span><span class="o">/</span><span class="nv">poll</span> <span class="o">|</span> <span class="nv">select</span> <span class="o">|</span> <span class="nv">poll</span> ]<span class="c1">; epoll模型是Linux 2.6以上版本内核中的多路复用高性能网络I/O模型，如果跑在FreeBSD上面，就用kqueue模型</span>
<span class="nv">use</span> <span class="nv">epoll</span><span class="c1">;</span>
#单个进程最大并发连接数（最大连接数<span class="o">=</span>连接数<span class="o">*</span>进程数）
<span class="nv">worker_connections</span> <span class="mi">65535</span><span class="c1">;</span>

# 并发总数是 <span class="nv">worker_processes</span> 和 <span class="nv">worker_connections</span> 的乘积,即 <span class="nv">max_clients</span> <span class="o">=</span> <span class="nv">worker_processes</span> <span class="o">*</span> <span class="nv">worker_connections</span>
# 在设置了反向代理的情况下，<span class="nv">max_clients</span> <span class="o">=</span> <span class="nv">worker_processes</span> <span class="o">*</span><span class="nv">worker_connections</span> <span class="o">/</span> <span class="mi">4</span>
# 为什么上面反向代理要除以<span class="mi">4</span>，应该说是一个经验值
# 根据以上条件，正常情况下的<span class="nv">Nginx</span> <span class="nv">Server</span>可以应付的最大连接数为：<span class="mi">4</span><span class="o">*</span> <span class="mi">8000</span> <span class="o">=</span> <span class="mi">32000</span>
# <span class="nv">worker_connections</span> 值的设置跟物理内存大小有关
# 因为并发受<span class="nv">IO</span>约束，<span class="nv">max_clients</span>的值须小于系统可以打开的最大文件数
# 而系统可以打开的最大文件数和内存大小成正比，一般<span class="mi">1</span><span class="nv">GB</span>内存的机器上以打开的文件数大约是<span class="mi">10</span>万左右
# 我们来看看<span class="mi">360</span><span class="nv">M</span>内存的<span class="nv">VPS</span>可以打开的文件句柄数是多少：
# $ <span class="nv">cat</span> <span class="o">/</span><span class="nv">proc</span><span class="o">/</span><span class="nv">sys</span><span class="o">/</span><span class="nv">fs</span><span class="o">/</span><span class="nv">file</span><span class="o">-</span><span class="nv">max</span>
# 输出 <span class="mi">34336</span>
# <span class="mi">32000</span> <span class="o">&lt;</span> <span class="mi">34336</span>，即并发连接总数小于系统可以打开的文件句柄总数，样就在操作系统可以承受的范围之内
# 所以，<span class="nv">worker_connections</span> 的值需根据 <span class="nv">worker_processes</span> 进程数和系统可以打开的最大文件总数进行适当地进行设置
# 使得并发总数小于操作系统可以打开的最大文件数目
# 其实质也就是根据主机的物理<span class="nv">CPU</span>和内存进行配置
# 当然，理论上的并发总数可能会和实际有所偏差，因为主机还有其他的作进程需要消耗系统资源
# <span class="nv">ulimit</span> <span class="o">-</span><span class="nv">SHn</span> <span class="mi">65535</span>

<span class="nv">multi_accept</span> <span class="nv">on</span><span class="c1">;</span>
}

#设定<span class="nv">http</span>服务器
<span class="nv">http</span>
{
<span class="k">include</span> <span class="nv">mime</span>.<span class="nv">types</span><span class="c1">; #文件扩展名与文件类型映射表</span>
<span class="nv">default_type</span> <span class="nv">application</span><span class="o">/</span><span class="nv">octet</span><span class="o">-</span><span class="nv">stream</span><span class="c1">; #默认文件类型</span>
#<span class="nv">charset</span> <span class="nv">utf</span><span class="o">-</span><span class="mi">8</span><span class="c1">; #默认编码</span>
<span class="nv">server_names_hash_bucket_size</span> <span class="mi">128</span><span class="c1">; #服务器名字的hash表大小</span>
<span class="nv">client_header_buffer_size</span> <span class="mi">32</span><span class="nv">k</span><span class="c1">; #上传文件大小限制</span>
<span class="nv">large_client_header_buffers</span> <span class="mi">4</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">; #设定请求缓存</span>
<span class="nv">client_max_body_size</span> <span class="mi">8</span><span class="nv">m</span><span class="c1">; #设定请求缓存</span>
<span class="k">sendfile</span> <span class="nv">on</span><span class="c1">; #开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数（zero copy 方式）来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off</span>
<span class="nv">autoindex</span> <span class="nv">on</span><span class="c1">; #开启目录列表访问，合适下载服务器，默认关闭</span>
<span class="nv">tcp_nopush</span> <span class="nv">on</span><span class="c1">; #防止网络阻塞</span>
<span class="nv">tcp_nodelay</span> <span class="nv">on</span><span class="c1">; #防止网络阻塞</span>
<span class="nv">keepalive_timeout</span> <span class="mi">120</span><span class="c1">; #长连接超时时间，单位是秒</span>

#<span class="nv">FastCGI</span>相关参数是为了改善网站的性能：减少资源占用，提高访问速度。下面参数看字面意思都能理解
<span class="nv">fastcgi_connect_timeout</span> <span class="mi">60</span><span class="c1">; # 默认60s，建立连接越多消耗资源越多</span>
<span class="nv">fastcgi_send_timeout</span> <span class="mi">60</span><span class="c1">;</span>
<span class="nv">fastcgi_read_timeout</span> <span class="mi">60</span><span class="c1">;</span>
<span class="nv">fastcgi_buffer_size</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">;</span>
<span class="nv">fastcgi_buffers</span> <span class="mi">4</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">;</span>
<span class="nv">fastcgi_busy_buffers_size</span> <span class="mi">128</span><span class="nv">k</span><span class="c1">;</span>
<span class="nv">fastcgi_temp_file_write_size</span> <span class="mi">256</span><span class="nv">k</span><span class="c1">;</span>
<span class="nv">fastcgi_intercept_errors</span> <span class="nv">on</span><span class="c1">;</span>
<span class="nv">fastcgi_cache_valid</span> <span class="mi">200</span> <span class="mi">302</span> <span class="mi">1</span><span class="nv">h</span><span class="c1">; # 指定应答代码缓存时间</span>
<span class="nv">fastcgi_cache_min_uses</span> <span class="mi">1</span><span class="c1">; # 请求几次响应后将被缓存，1表示一次就缓存</span>
<span class="nv">fastcgi_cache_use_stale</span> <span class="nv">error</span> <span class="nb">timeout</span> <span class="nv">invalid_header</span> <span class="nv">http_500</span><span class="c1">;  # 定义那种情况下使用过期缓存</span>
<span class="nv">fastcgi_cache_key</span> $<span class="nv">request_method</span>:<span class="o">//</span>$<span class="nv">host</span>$<span class="nv">request_uri</span><span class="c1">;  # 此示例以请求的uri作为缓存的key值</span>

#<span class="nv">gzip</span>模块设置
<span class="nv">gzip</span> <span class="nv">on</span><span class="c1">; #开启gzip压缩输出</span>
<span class="nv">gzip_min_length</span> <span class="mi">1</span><span class="nv">k</span><span class="c1">; #最小压缩文件大小</span>
<span class="nv">gzip_buffers</span> <span class="mi">4</span> <span class="mi">16</span><span class="nv">k</span><span class="c1">; #压缩缓冲区</span>
<span class="nv">gzip_http_version</span> <span class="mi">1</span>.<span class="mi">1</span><span class="c1">; #压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span>
<span class="nv">gzip_comp_level</span> <span class="mi">2</span><span class="c1">; #压缩等级</span>
<span class="nv">gzip_types</span> <span class="nv">text</span><span class="o">/</span><span class="nv">plain</span> <span class="nv">application</span><span class="o">/</span><span class="nv">x</span><span class="o">-</span><span class="nv">javascript</span> <span class="nv">text</span><span class="o">/</span><span class="nv">javascript</span> <span class="nv">text</span><span class="o">/</span><span class="nv">css</span> <span class="nv">application</span><span class="o">/</span><span class="nv">xml</span><span class="c1">;</span>
#压缩类型，默认就已经包含<span class="nv">text</span><span class="o">/</span><span class="nv">html</span>，所以下面就不用再写了，写上去也不会有问题，但是会有一个<span class="nv">warn</span>
<span class="nv">gzip_vary</span> <span class="nv">on</span><span class="c1">;</span>
#<span class="nv">limit_zone</span> <span class="nv">crawler</span> <span class="mh">$b</span><span class="nv">inary_remote_addr</span> <span class="mi">10</span><span class="nv">m</span><span class="c1">; #开启限制IP连接数的时候需要使用</span>
<span class="nv">gzip_proxied</span>   <span class="nv">expired</span> <span class="nv">no</span><span class="o">-</span><span class="nv">cache</span> <span class="nv">no</span><span class="o">-</span><span class="nv">store</span> <span class="nv">private</span> <span class="nv">auth</span><span class="c1">;</span>
<span class="nv">gzip_disable</span>   <span class="s2">&quot;</span><span class="s">MSIE [1-6]\.</span><span class="s2">&quot;</span><span class="c1">;</span>
<span class="nv">limit_conn_zone</span> <span class="mh">$b</span><span class="nv">inary_remote_addr</span> <span class="nv">zone</span><span class="o">=</span><span class="nv">perip</span>:<span class="mi">10</span><span class="nv">m</span><span class="c1">;</span>
<span class="nv">limit_conn_zone</span> $<span class="nv">server_name</span> <span class="nv">zone</span><span class="o">=</span><span class="nv">perserver</span>:<span class="mi">10</span><span class="nv">m</span><span class="c1">;</span>

<span class="nv">server_tokens</span> <span class="nv">off</span><span class="c1">;</span>
<span class="nv">access_log</span> <span class="nv">off</span><span class="c1">;</span>

<span class="nv">upstream</span> <span class="nv">www</span>.<span class="mi">19950128</span>.<span class="nv">com</span> {
#<span class="nv">upstream</span>的负载均衡，<span class="nv">weight</span>是权重，可以根据机器配置定义权重。<span class="nv">weigth</span>参数表示权值，权值越高被分配到的几率越大
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">80</span>.<span class="mi">121</span>:<span class="mi">80</span> <span class="nv">weight</span><span class="o">=</span><span class="mi">3</span><span class="c1">;</span>
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">80</span>.<span class="mi">122</span>:<span class="mi">80</span> <span class="nv">weight</span><span class="o">=</span><span class="mi">2</span><span class="c1">;</span>
<span class="nv">server</span> <span class="mi">192</span>.<span class="mi">168</span>.<span class="mi">80</span>.<span class="mi">123</span>:<span class="mi">80</span> <span class="nv">weight</span><span class="o">=</span><span class="mi">3</span><span class="c1">;</span>
}

#虚拟主机的配置
<span class="nv">server</span>
{
  #监听端口
  <span class="nv">listen</span> <span class="mi">80</span><span class="c1">;</span>
  #域名可以有多个，用空格隔开
  <span class="nv">server_name</span> <span class="nv">www</span>.<span class="mi">19950128</span>.<span class="nv">com</span><span class="c1">;</span>
  <span class="nv">index</span> <span class="nv">index</span>.<span class="nv">html</span> <span class="nv">index</span>.<span class="nv">htm</span> <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
  <span class="nv">root</span> <span class="o">/</span><span class="nv">data</span><span class="o">/</span><span class="nv">www</span><span class="o">/</span><span class="c1">;</span>

  #<span class="nv">error_page</span>   <span class="mi">404</span>   <span class="o">/</span><span class="mi">404</span>.<span class="nv">html</span><span class="c1">;</span>
  <span class="k">include</span> <span class="nv">enable</span><span class="o">-</span><span class="nv">php</span>.<span class="nv">conf</span><span class="c1">;</span>

  <span class="nv">location</span> <span class="o">~</span> .<span class="o">*</span>\.<span class="ss">(</span><span class="nv">php</span><span class="o">|</span><span class="nv">php5</span><span class="o">|</span><span class="ss">)</span>?$
  {
  <span class="nv">fastcgi_pass</span> <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">9000</span><span class="c1">;</span>
  <span class="nv">fastcgi_index</span> <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
  <span class="k">include</span> <span class="nv">fastcgi</span>.<span class="nv">conf</span><span class="c1">;</span>
  }
  #图片缓存时间设置
  <span class="nv">location</span> <span class="o">~</span> .<span class="o">*</span>\.<span class="ss">(</span><span class="nv">gif</span><span class="o">|</span><span class="nv">jpg</span><span class="o">|</span><span class="nv">jpeg</span><span class="o">|</span><span class="nv">png</span><span class="o">|</span><span class="nv">bmp</span><span class="o">|</span><span class="nv">swf</span><span class="ss">)</span>$
  {
  <span class="nv">expires</span> <span class="mi">10</span><span class="nv">d</span><span class="c1">;</span>
  }
  #<span class="nv">JS</span>和<span class="nv">CSS</span>缓存时间设置
  <span class="nv">location</span> <span class="o">~</span> .<span class="o">*</span>\.<span class="ss">(</span><span class="nv">js</span><span class="o">|</span><span class="nv">css</span><span class="ss">)</span>?$
  {
  <span class="nv">expires</span> <span class="mi">1</span><span class="nv">h</span><span class="c1">;</span>
  }
  # 定义错误提示页面
  <span class="nv">error_page</span>   <span class="mi">500</span> <span class="mi">502</span> <span class="mi">503</span> <span class="mi">504</span> <span class="o">/</span><span class="mi">50</span><span class="nv">x</span>.<span class="nv">html</span><span class="c1">;</span>
  <span class="nv">location</span> <span class="o">=</span> <span class="o">/</span><span class="mi">50</span><span class="nv">x</span>.<span class="nv">html</span> {
  }
  #日志格式<span class="mi">1</span>
  <span class="nv">log_format</span> <span class="nv">access</span> <span class="s1">&#39;</span><span class="s">$remote_addr - $remote_user [$time_local] &quot;$request&quot; </span><span class="s1">&#39;</span>
  <span class="s1">&#39;</span><span class="s">$status $body_bytes_sent &quot;$http_referer&quot; </span><span class="s1">&#39;</span>
  <span class="s1">&#39;</span><span class="s">&quot;$http_user_agent&quot; $http_x_forwarded_for</span><span class="s1">&#39;</span><span class="c1">;</span>
# 日志格式<span class="mi">2</span>
<span class="nv">log_format</span> <span class="nv">custom</span> <span class="s1">&#39;</span><span class="s">$remote_addr - $remote_user [$time_local] </span><span class="s1">&#39;</span>
<span class="s1">&#39;</span><span class="s">&quot;$request&quot; $status $body_bytes_sent </span><span class="s1">&#39;</span>
<span class="s1">&#39;</span><span class="s">&quot;$http_referer&quot; &quot;$http_user_agent&quot; </span><span class="s1">&#39;</span>
<span class="s1">&#39;</span><span class="s">&quot;$http_x_forwarded_for&quot; $request_id </span><span class="s1">&#39;</span>
<span class="s1">&#39;</span><span class="s">$geoip_country_name $geoip_country_code </span><span class="s1">&#39;</span>
<span class="s1">&#39;</span><span class="s">$geoip_region_name $geoip_city </span><span class="s1">&#39;</span><span class="c1">;</span>
  #定义本虚拟主机的访问日志
  <span class="nv">access_log</span> <span class="o">/</span><span class="nv">var</span><span class="o">/</span><span class="nv">log</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">access</span>.<span class="nv">log</span><span class="c1">;</span>

  #对 <span class="s2">&quot;</span><span class="s">/</span><span class="s2">&quot;</span> 启用反向代理
  <span class="nv">location</span> <span class="o">/</span> {
  <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">88</span><span class="c1">;</span>
  <span class="nv">proxy_redirect</span> <span class="nv">off</span><span class="c1">;</span>
  <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Real</span><span class="o">-</span><span class="nv">IP</span> $<span class="nv">remote_addr</span><span class="c1">;</span>
  #后端的<span class="nv">Web</span>服务器可以通过<span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="nv">For</span>获取用户真实<span class="nv">IP</span>
  <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span> $<span class="nv">proxy_add_x_forwarded_for</span><span class="c1">;</span>
  #以下是一些反向代理的配置，可选
  <span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">host</span><span class="c1">;</span>
  <span class="nv">client_max_body_size</span> <span class="mi">10</span><span class="nv">m</span><span class="c1">; #允许客户端请求的最大单文件字节数</span>
  <span class="nv">client_body_buffer_size</span> <span class="mi">128</span><span class="nv">k</span><span class="c1">; #缓冲区代理缓冲用户端请求的最大字节数</span>
  <span class="nv">proxy_connect_timeout</span> <span class="mi">90</span><span class="c1">; #nginx跟后端服务器连接超时时间(代理连接超时)</span>
  <span class="nv">proxy_send_timeout</span> <span class="mi">90</span><span class="c1">; #后端服务器数据回传时间(代理发送超时)</span>
  <span class="nv">proxy_read_timeout</span> <span class="mi">90</span><span class="c1">; #连接成功后，后端服务器响应时间(代理接收超时)</span>
  <span class="nv">proxy_buffer_size</span> <span class="mi">4</span><span class="nv">k</span><span class="c1">; #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span>
  <span class="nv">proxy_buffers</span> <span class="mi">4</span> <span class="mi">32</span><span class="nv">k</span><span class="c1">; #proxy_buffers缓冲区，网页平均在32k以下的设置</span>
  <span class="nv">proxy_busy_buffers_size</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">; #高负荷下缓冲大小（proxy_buffers*2）</span>
  <span class="nv">proxy_temp_file_write_size</span> <span class="mi">64</span><span class="nv">k</span><span class="c1">;</span>
  #设定缓存文件夹大小，大于这个值，将从<span class="nv">upstream</span>服务器传
  }

  #设定查看<span class="nv">Nginx</span>状态的地址
  <span class="nv">location</span> <span class="o">/</span><span class="nv">NginxStatus</span> {
  <span class="nv">stub_status</span> <span class="nv">on</span><span class="c1">;</span>
  <span class="nv">access_log</span> <span class="nv">on</span><span class="c1">;</span>
  <span class="nv">auth_basic</span> <span class="s2">&quot;</span><span class="s">NginxStatus</span><span class="s2">&quot;</span><span class="c1">;</span>
  <span class="nv">auth_basic_user_file</span> <span class="nv">conf</span><span class="o">/</span><span class="nv">htpasswd</span><span class="c1">;</span>
  #<span class="nv">htpasswd</span>文件的内容可以用<span class="nv">apache</span>提供的<span class="nv">htpasswd</span>工具来产生
  }

  #本地动静分离反向代理配置
  #所有<span class="nv">jsp</span>的页面均交由<span class="nv">tomcat</span>或<span class="nv">resin</span>处理
  <span class="nv">location</span> <span class="o">~</span> .<span class="ss">(</span><span class="nv">jsp</span><span class="o">|</span><span class="nv">jspx</span><span class="o">|</span><span class="k">do</span><span class="ss">)</span>?$ {
  <span class="nv">proxy_set_header</span> <span class="nv">Host</span> $<span class="nv">host</span><span class="c1">;</span>
  <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Real</span><span class="o">-</span><span class="nv">IP</span> $<span class="nv">remote_addr</span><span class="c1">;</span>
  <span class="nv">proxy_set_header</span> <span class="nv">X</span><span class="o">-</span><span class="nv">Forwarded</span><span class="o">-</span><span class="k">For</span> $<span class="nv">proxy_add_x_forwarded_for</span><span class="c1">;</span>
  <span class="nv">proxy_pass</span> <span class="nv">http</span>:<span class="o">//</span><span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">8080</span><span class="c1">;</span>
  }
  #所有静态文件由<span class="nv">nginx</span>直接读取不经过<span class="nv">tomcat</span>或<span class="nv">resin</span>
  <span class="nv">location</span> <span class="o">~</span> .<span class="o">*</span>.<span class="ss">(</span><span class="nv">htm</span><span class="o">|</span><span class="nv">html</span><span class="o">|</span><span class="nv">gif</span><span class="o">|</span><span class="nv">jpg</span><span class="o">|</span><span class="nv">jpeg</span><span class="o">|</span><span class="nv">png</span><span class="o">|</span><span class="nv">bmp</span><span class="o">|</span><span class="nv">swf</span><span class="o">|</span><span class="nv">ioc</span><span class="o">|</span><span class="nv">rar</span><span class="o">|</span><span class="nv">zip</span><span class="o">|</span><span class="nv">txt</span><span class="o">|</span><span class="nv">flv</span><span class="o">|</span><span class="nv">mid</span><span class="o">|</span><span class="nv">doc</span><span class="o">|</span><span class="nv">ppt</span><span class="o">|</span><span class="nv">pdf</span><span class="o">|</span><span class="nv">xls</span><span class="o">|</span><span class="nv">mp3</span><span class="o">|</span><span class="nv">wma</span><span class="ss">)</span>$
  {
    <span class="nv">expires</span> <span class="mi">15</span><span class="nv">d</span><span class="c1">;</span>
  }
  <span class="nv">location</span> <span class="o">~</span> .<span class="o">*</span>.<span class="ss">(</span><span class="nv">js</span><span class="o">|</span><span class="nv">css</span><span class="ss">)</span>?$
  {
    <span class="nv">expires</span> <span class="mi">1</span><span class="nv">h</span><span class="c1">;</span>
  }

#禁止访问 .<span class="nv">htxxx</span> 文件
  <span class="nv">location</span> <span class="o">~</span> <span class="o">/</span>.<span class="nv">ht</span> {
  <span class="nv">deny</span> <span class="nv">all</span><span class="c1">;</span>
  }
}
}
</pre></div>

<p>nginx.conf配置补充扩展：</p>
<div class="codehilite"><pre><span></span>#静态文件，<span class="nv">nginx</span>自己处理
<span class="nv">location</span> <span class="o">~</span> <span class="o">^/</span><span class="ss">(</span><span class="nv">images</span><span class="o">|</span><span class="nv">javascript</span><span class="o">|</span><span class="nv">js</span><span class="o">|</span><span class="nv">css</span><span class="o">|</span><span class="nv">flash</span><span class="o">|</span><span class="nv">media</span><span class="o">|</span><span class="nv">static</span><span class="o">/</span> {
    #过期<span class="mi">30</span>天，静态文件不怎么更新，过期可以设大一点
    #如果频繁更新，则可以设置得小一点
    <span class="nv">expires</span> <span class="mi">30</span><span class="nv">d</span><span class="c1">;</span>
}

#<span class="nv">PHP</span> 脚本请求全部转发到 <span class="nv">FastCGI</span>处理. 使用<span class="nv">FastCGI</span>默认配置.
<span class="nv">location</span> <span class="o">~*</span> \.<span class="nv">php</span>$ {
    <span class="nv">fastcgi_index</span>   <span class="nv">index</span>.<span class="nv">php</span><span class="c1">;</span>
    <span class="nv">fastcgi_pass</span>    <span class="mi">127</span>.<span class="mi">0</span>.<span class="mi">0</span>.<span class="mi">1</span>:<span class="mi">9000</span><span class="c1">;</span>
    <span class="k">include</span>         <span class="nv">fastcgi_params</span><span class="c1">;</span>
    <span class="nv">fastcgi_param</span>   <span class="nv">SCRIPT_FILENAME</span>       <span class="mh">$d</span><span class="nv">ocument_root</span><span class="mh">$fa</span><span class="nv">stcgi_script_name</span><span class="c1">;</span>
    <span class="nv">fastcgi_param</span>   <span class="nv">SCRIPT_NAME</span>        <span class="mh">$fa</span><span class="nv">stcgi_script_name</span><span class="c1">;</span>
  }
# 拒绝图片热链接
<span class="nv">location</span> <span class="o">/</span><span class="nv">images</span><span class="o">/</span> {
  <span class="nv">valid_referers</span> <span class="nv">none</span> <span class="nv">blocked</span> <span class="nv">www</span>.<span class="nv">example</span>.<span class="nv">com</span> <span class="nv">example</span>.<span class="nv">com</span><span class="c1">;</span>
   <span class="k">if</span> <span class="ss">(</span>$<span class="nv">invalid_referer</span><span class="ss">)</span> {
     <span class="k">return</span>   <span class="mi">403</span><span class="c1">;</span>
   }
}

另外一个方法可跳转到一个固定的图片链接或<span class="nv">url</span>
<span class="nv">valid_referers</span> <span class="nv">blocked</span> <span class="nv">www</span>.<span class="nv">example</span>.<span class="nv">com</span> <span class="nv">example</span>.<span class="nv">com</span><span class="c1">;</span>
 <span class="k">if</span> <span class="ss">(</span>$<span class="nv">invalid_referer</span><span class="ss">)</span> {
  <span class="nv">rewrite</span> <span class="o">^/</span><span class="nv">images</span><span class="o">/</span><span class="nv">uploads</span>.<span class="o">*</span>\.<span class="ss">(</span><span class="nv">gif</span><span class="o">|</span><span class="nv">jpg</span><span class="o">|</span><span class="nv">jpeg</span><span class="o">|</span><span class="nv">png</span><span class="ss">)</span>$ <span class="nv">http</span>:<span class="o">//</span><span class="nv">www</span>.<span class="nv">examples</span>.<span class="nv">com</span><span class="o">/</span><span class="nv">banned</span>.<span class="nv">jpg</span> <span class="nv">last</span>
 }

### <span class="nv">Password</span> <span class="nv">Protect</span> <span class="o">/</span><span class="nv">personal</span><span class="o">-</span><span class="nv">images</span><span class="o">/</span> <span class="nv">and</span> <span class="o">/</span><span class="nv">delta</span><span class="o">/</span> <span class="nv">directories</span> ###
<span class="nv">location</span> <span class="o">~</span> <span class="o">/</span><span class="ss">(</span><span class="nv">personal</span><span class="o">-</span><span class="nv">images</span><span class="o">/</span>.<span class="o">*|</span><span class="nv">delta</span><span class="o">/</span>.<span class="o">*</span><span class="ss">)</span> {
  <span class="nv">auth_basic</span>  <span class="s2">&quot;</span><span class="s">Restricted</span><span class="s2">&quot;</span><span class="c1">;</span>
  <span class="nv">auth_basic_user_file</span>   <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">conf</span><span class="o">/</span>.<span class="nv">htpasswd</span><span class="o">/</span><span class="nv">passwd</span><span class="c1">;</span>
}

<span class="nv">Create</span> <span class="nv">an</span> <span class="nv">SSL</span> <span class="nv">Certificate</span>
# <span class="nv">cd</span> <span class="o">/</span><span class="nv">usr</span><span class="o">/</span><span class="nv">local</span><span class="o">/</span><span class="nv">nginx</span><span class="o">/</span><span class="nv">conf</span>
# <span class="nv">openssl</span> <span class="nv">genrsa</span> <span class="o">-</span><span class="nv">des3</span> <span class="o">-</span><span class="nv">out</span> <span class="nv">server</span>.<span class="nv">key</span> <span class="mi">1024</span>
# <span class="nv">openssl</span> <span class="nv">req</span> <span class="o">-</span><span class="nv">new</span> <span class="o">-</span><span class="nv">key</span> <span class="nv">server</span>.<span class="nv">key</span> <span class="o">-</span><span class="nv">out</span> <span class="nv">server</span>.<span class="nv">csr</span>
# <span class="nv">cp</span> <span class="nv">server</span>.<span class="nv">key</span> <span class="nv">server</span>.<span class="nv">key</span>.<span class="nv">org</span>
# <span class="nv">openssl</span> <span class="nv">rsa</span> <span class="o">-</span><span class="nv">in</span> <span class="nv">server</span>.<span class="nv">key</span>.<span class="nv">org</span> <span class="o">-</span><span class="nv">out</span> <span class="nv">server</span>.<span class="nv">key</span>
# <span class="nv">openssl</span> <span class="nv">x509</span> <span class="o">-</span><span class="nv">req</span> <span class="o">-</span><span class="nv">days</span> <span class="mi">365</span> <span class="o">-</span><span class="nv">in</span> <span class="nv">server</span>.<span class="nv">csr</span> <span class="o">-</span><span class="nv">signkey</span> <span class="nv">server</span>.<span class="nv">key</span> <span class="o">-</span><span class="nv">out</span> <span class="nv">server</span>.<span class="nv">crt</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="err">#</span> <span class="nt">多路径多站点同一个端口</span>
<span class="nt">server</span> <span class="p">{</span>
    <span class="err">listen</span> <span class="err">8080</span><span class="p">;</span>
    <span class="err">server_name</span> <span class="err">localhost</span><span class="p">;</span>
    <span class="err">root</span> <span class="err">/home/ajit/git/univisior</span><span class="p">;</span>

<span class="err">location</span> <span class="err">/</span> <span class="err">{</span>
    <span class="err">alias</span> <span class="err">/home/ajit/git/project-x/buyer/dist/</span><span class="p">;</span>
    <span class="err">index</span> <span class="err">index.html</span><span class="p">;</span>
    <span class="err">try_files</span> <span class="err">$uri</span> <span class="err">$uri/</span> <span class="err">/index.html</span><span class="p">;</span>

<span class="p">}</span>
<span class="nt">location</span> <span class="o">/</span><span class="nt">admin</span><span class="p">{</span>
    <span class="err">alias</span> <span class="err">/home/ajit/git/project-x/admin/dist/</span><span class="p">;</span>
    <span class="err">index</span> <span class="err">index.html</span><span class="p">;</span>
    <span class="err">try_files</span> <span class="err">$uri</span> <span class="err">$uri/</span> <span class="err">index.html</span><span class="p">;</span>

<span class="p">}</span>

<span class="nt">location</span> <span class="o">/</span><span class="nt">seller</span> <span class="p">{</span>
    <span class="err">alias</span> <span class="err">/home/ajit/git/project-x/seller/dist/</span><span class="p">;</span>
    <span class="err">index</span> <span class="err">index.html</span><span class="p">;</span>
    <span class="err">try_files</span> <span class="err">$uri</span> <span class="err">$uri/</span> <span class="err">/index.html</span><span class="p">;</span>

<span class="p">}</span>

<span class="nt">location</span> <span class="o">/</span><span class="nt">api</span> <span class="p">{</span>
    <span class="err">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="o">:</span><span class="mi">3000</span><span class="o">/</span><span class="n">api</span><span class="p">;</span>

 <span class="p">}</span>

<span class="err">}</span>
</pre></div>

<h2 id="nginx_1">nginx日志相关命令<a class="headerlink" href="#nginx_1" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span>nginx日志最好实现每天定时切割下，特别是在访问量比较大的时候，方便查看与处理，如果没切割，可以用sed直接切割

切割日志

查找7月17日访问log导出到17.log文件中：

cat gelin_web_access.log <span class="p">|</span> egrep <span class="s2">&quot;17/Jul/2017&quot;</span> <span class="p">|</span> sed  -n <span class="s1">&#39;/00:00:00/,/23:59:59/p&#39;</span> &gt; /tmp/17.log
查看访问量前10的IP

awk <span class="s1">&#39;{print $1}&#39;</span> <span class="m">17</span>.log <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -nr <span class="p">|</span> head -n <span class="m">10</span>
查看访问前10的URL

awk <span class="s1">&#39;{print $11}&#39;</span> gelin_web_access.log <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -nr <span class="p">|</span> head -n <span class="m">10</span>
查询访问最频繁的URL

awk <span class="s1">&#39;{print $7}&#39;</span> gelin_web_access.log <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -n -k <span class="m">1</span> -r <span class="p">|</span> more
查询访问最频繁的IP

awk <span class="s1">&#39;{print $1}&#39;</span> gelin_web_access.log <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> sort -n -k <span class="m">1</span> -r <span class="p">|</span> more
根据访问IP统计UV

awk <span class="s1">&#39;{print $1}&#39;</span> gelin_web_access.log <span class="p">|</span> sort <span class="p">|</span> uniq -c <span class="p">|</span> wc -l
统计访问URL统计PV

awk <span class="s1">&#39;{print $7}&#39;</span> gelin_web_access.log <span class="p">|</span> wc -l
根据时间段统计查看日志

cat gelin_web_access.log <span class="p">|</span> sed -n <span class="s1">&#39;/17\/Jul\/2017:12/,/17\/Jul\/2017:13/p&#39;</span> <span class="p">|</span> more
</pre></div>

<h2 id="unit180">Unit1.8.0<a class="headerlink" href="#unit180" title="Permanent link">&para;</a></h2>
<div class="codehilite"><pre><span></span><span class="c1"># Control socket位置：/var/run/control.unit.sock</span>
cat <span class="s">&lt;&lt; EOF &gt; /etc/yum.repos.d/unit.repo</span>
<span class="s">[unit]</span>
<span class="s">name=unit repo</span>
<span class="s">baseurl=https://packages.nginx.org/unit/centos/7/$basearch/</span>
<span class="s">gpgcheck=0</span>
<span class="s">enabled=1</span>
<span class="s">EOF</span>

<span class="c1"># 设置一个application对象,利用json文件，将对象放入到config/applications下的blogs块中</span>
curl -X PUT --data-binary @config.json --unix-socket /var/run/control.unit.sock http://localhost/config/applications/blogs/
<span class="c1"># 从listeners对象引用application对象，其包括IP(或任何匹配IP的通配符)和端口号config/listeners</span>
curl -X PUT --data-binary @config.json --unix-socket /var/run/control.unit.sock http://localhost/config/listeners/127.0.0.1:8300
<span class="c1"># 检查目前的配置，也可以一次性上传上面的两步的全部配置</span>
curl --unix-socket /var/run/control.unit.sock http://localhost/config/

<span class="c1"># 创建对象</span>
curl -X PUT -d @/path/to/start.json --unix-socket /var/run/control.unit.sock http://localhost/config/
<span class="c1"># 修改application对象blogs,将其listeners更改为*:8400</span>
curl -X PUT -d <span class="s1">&#39;&quot;blogs&quot;&#39;</span> --unix-socket /var/run/control.unit.sock <span class="s1">&#39;http://localhost/config/listeners/*:8400/application&#39;</span>
<span class="c1"># 将blogs的application对象中的root参数更改为/www/blogs-dev</span>
curl -X PUT -d <span class="s1">&#39;&quot;/www/blogs-dev&quot;&#39;</span>  --unix-socket /var/run/control.unit.sock http://localhost/config/applications/blogs/root
<span class="c1"># 删除对象，要删除对象，需要发出DELETE请求并将对象的路径附加到curl URL。如下：删除listener监听*:8400</span>
curl -X DELETE --unix-socket /var/run/control.unit.sock <span class="s1">&#39;http://localhost/config/listeners/*:8400&#39;</span>

<span class="c1"># listeners</span>
<span class="p">|</span> 选项 <span class="p">|</span> 描述 <span class="p">|</span>
<span class="p">|</span> :------: <span class="p">|</span> :------: <span class="p">|</span>
<span class="p">|</span> application<span class="o">(</span>已废弃<span class="o">)</span> <span class="p">|</span> 应用名称,与pass互斥 <span class="p">|</span>
<span class="p">|</span> pass<span class="o">(</span>required<span class="o">)</span> <span class="p">|</span> 应用或路由名称：<span class="s2">&quot;pass&quot;</span>:<span class="s2">&quot;routers/route66&quot;</span>,<span class="s2">&quot;pass&quot;</span>:<span class="s2">&quot;applications/smart&quot;</span> <span class="p">|</span>
<span class="p">|</span> tls <span class="p">|</span> SSL/TLS配置,添加certificate实现listener加密通信 <span class="p">|</span>

<span class="c1"># Routers,利用routers对象实现listeners和apps内部路由，listeners将请求传递给pass或直接传递给应用程序</span>
</pre></div>

<div class="codehilite"><pre><span></span><span class="err">#</span> <span class="err">routers对象包含一个或多个route参数.例如：</span>
<span class="p">{</span>
     <span class="nt">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&quot;*:8300&quot;</span><span class="p">:</span> <span class="p">{</span>
             <span class="nt">&quot;pass&quot;</span><span class="p">:</span> <span class="s2">&quot;routes&quot;</span>
         <span class="p">}</span>
     <span class="p">},</span>

     <span class="nt">&quot;routes&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;simply referred to as routes&quot;</span> <span class="p">]</span>
<span class="p">}</span>

<span class="err">#</span> <span class="err">多个</span>
<span class="p">{</span>
     <span class="nt">&quot;listeners&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&quot;*:8300&quot;</span><span class="p">:</span> <span class="p">{</span>
             <span class="nt">&quot;pass&quot;</span><span class="p">:</span> <span class="s2">&quot;routes/main&quot;</span>
         <span class="p">}</span>
     <span class="p">},</span>

     <span class="nt">&quot;routes&quot;</span><span class="p">:</span> <span class="p">{</span>
         <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;named route, qualified name: routes/main&quot;</span> <span class="p">],</span>
         <span class="nt">&quot;route66&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;named route, qualified name: routes/route66&quot;</span> <span class="p">]</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>route参数包含匿名对象或steps。请求通过route去遍历，steps有如下选项
| 选项 | 描述 |
| :------: | :------: |
| match | 定义步骤条件的对象，如果请求和match条件匹配，pass步骤将生效，如果不匹配，将继续进行route的下一步，如果都不匹配，返回404错误 |
| action/pass(required) | route的目的地，如果忽略了match，请求直接通过，避免出错，每个route使用一个这样的步骤并放在最后 |</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;routes&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;example.com&quot;</span><span class="p">,</span>
                <span class="nt">&quot;uri&quot;</span><span class="p">:</span> <span class="s2">&quot;/admin/*&quot;</span>
            <span class="p">},</span>

            <span class="nt">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;pass&quot;</span><span class="p">:</span> <span class="s2">&quot;applications/php5_app&quot;</span>
             <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="nt">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;pass&quot;</span><span class="p">:</span> <span class="s2">&quot;applications/php7_app&quot;</span>
             <span class="p">}</span>
        <span class="p">}</span>
     <span class="p">]</span>
<span class="p">}</span>

<span class="err">#</span> <span class="err">更详细的的示例</span>
<span class="p">{</span>
    <span class="nt">&quot;routes&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;main&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;www.example.com&quot;</span><span class="p">,</span> <span class="s2">&quot;example.com&quot;</span> <span class="p">]</span>
                <span class="p">},</span>

                <span class="nt">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;pass&quot;</span><span class="p">:</span> <span class="s2">&quot;routes/site&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;blog.example.com&quot;</span>
                <span class="p">},</span>

                <span class="nt">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;pass&quot;</span><span class="p">:</span> <span class="s2">&quot;applications/blog&quot;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">],</span>

        <span class="nt">&quot;site&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;...&quot;</span> <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="err">#</span> <span class="err">条件匹配；步骤中的匹配条件包括请求属性名称和相应的pattern</span>
<span class="p">{</span>
    <span class="nt">&quot;match&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;request_property1&quot;</span><span class="p">:</span> <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
        <span class="nt">&quot;request_property2&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span> <span class="p">]</span>
    <span class="p">},</span>

    <span class="nt">&quot;action&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;pass&quot;</span><span class="p">:</span> <span class="s2">&quot;...&quot;</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<table>
<thead>
<tr>
<th align="center">选项</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">host</td>
<td align="center">请求主机从Host没有端口号的header字段，通过删除尾随句点（如果有的话）进行规范化;不区分大小写</td>
</tr>
<tr>
<td align="center">method</td>
<td align="center">来自请求行的请求方法;不区分大小写</td>
</tr>
<tr>
<td align="center">uri</td>
<td align="center">请求URI没有参数的路径，通过解码“%XX”序列，解析相对路径引用（“.”和“..”），并将相邻斜杠压缩为一个;区分大小写</td>
</tr>
<tr>
<td align="center">pattern必须完全匹配，支持*和!</td>
<td align="center"></td>
</tr>
</tbody>
</table>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../Windows/" title="WindowsServer" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  上一页
                </span>
                WindowsServer
              </span>
            </div>
          </a>
        
        
          <a href="../Apache/" title="Apache" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  下一页
                </span>
                Apache
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/Black-Gold" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://www.instagram.com/black0gold/" class="md-footer-social__link fa fa-instagram"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c648116f.js"></script>
      
        
        
          
          <script src="../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
                <script src="../assets/javascripts/lunr/tinyseg.js"></script>
              
              
                <script src="../assets/javascripts/lunr/lunr.ja.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>